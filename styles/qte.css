/* 全屏遮罩：模糊背景，聚焦视线 */
#qte-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.4); /* 稍微调低一点透明度，不让背景太黑 */
    backdrop-filter: blur(2px);
    z-index: 10000;
    /* 去掉了 justify-content/align-items，因为内部容器现在自己定位 */
    display: block; 
    pointer-events: none;
    font-family: 'Signika', sans-serif;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}

#qte-overlay.active {
    opacity: 1;
}

/* QTE 主容器 */
.qte-container {
    /* 尺寸保持不变 */
    width: 300px;
    height: 300px;
    display: flex;
    justify-content: center;
    align-items: center;
    /* 位置由 JS 的 inline style 控制 (top, left, transform) */
    pointer-events: auto; /* 理论上不需要点击，但为了保险 */
}

/* 目标光圈 (Target Ring) */
.qte-target-ring {
    position: absolute;
    width: 150px;
    height: 150px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    z-index: 1;
}

.qte-target-ring::after {
    content: '';
    position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border: 2px solid #00d2ff;
    border-radius: 50%;
    opacity: 0.6;
}

/* 缩小的光圈 */
.qte-approach-ring {
    position: absolute;
    width: 300px;
    height: 300px;
    border: 6px solid #ff0055;
    border-radius: 50%;
    box-shadow: 0 0 20px #ff0055;
    z-index: 2;
}

/* 按键提示 UI */
.qte-key-prompt {
    position: relative;
    width: 80px;
    height: 80px;
    background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
    border: 2px solid #fff;
    border-radius: 12px;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 48px;
    font-weight: 900;
    box-shadow: 0 0 30px rgba(0, 210, 255, 0.5);
    z-index: 3;
    text-transform: uppercase;
}

.qte-key-prompt.space {
    width: 130px;
    height: 60px;
    font-size: 24px;
    border-radius: 8px;
    /*增加透明度 (0.9)，让判定线能稍微透出来一点 */
    background: linear-gradient(145deg, rgba(26,26,26,0.9), rgba(42,42,42,0.9)); 
}

/* 结果反馈文字 */
.qte-result {
    position: absolute;
    top: 110%; /* 在圈的下面显示 */
    width: 300px; /* 宽度设满防止换行问题 */
    text-align: center;
    font-size: 48px;
    font-weight: bold;
    text-shadow: 0 4px 10px rgba(0,0,0,0.8);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    white-space: nowrap;
}

.qte-result.show {
    opacity: 1;
    transform: translateY(0);
}

.result-perfect { color: #fbbf24; text-shadow: 0 0 20px #fbbf24; }
.result-good { color: #4ade80; text-shadow: 0 0 20px #4ade80; }
.result-bad { color: #f87171; text-shadow: 0 0 20px #f87171; }

@keyframes shrinkRing {
    from { transform: scale(1); opacity: 1; }
    to { transform: scale(0); opacity: 1; }
}

/* 让 wrapper 占满空间 */
.qte-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px; /* 元素间距 */
    height: 100%;
}

/* 确保窗口内容不出现双重滚动条 */
.qte-config-window form {
    height: 100%;
    overflow-y: auto; /* 允许内部滚动 */
    padding-right: 5px; /* 给滚动条留点位置 */
}
/* =========================================
   Dialog 样式 (适配 V13 Application V2)
   ========================================= */

/* 让 V2 窗口背景像样一点 */
.qte-config-window {
    padding: 10px;
    font-family: 'Signika', sans-serif;
    color: var(--color-text-light-primary);
    
    /* 在这里指定宽度，而不是在 JS 里 */
    width: 460px !important;
    height: auto !important;
}

/* 隐藏 V2 默认的 overflow-y，防止不必要的滚动条 */
.qte-config-window form {
    overflow-y: hidden;
}

/* 并排布局样式 */
.qte-two-col {
    display: flex;
    gap: 15px;
    justify-content: space-between;
    margin-bottom: 10px;
}

.qte-two-col .form-group {
    flex: 1;
    display: flex;
    flex-direction: column !important;
    align-items: center;
    height: auto !important;
    margin: 0;
    gap: 4px;
}

.qte-two-col input {
    width: 100%;
    text-align: center;
}

.qte-two-col label {
    font-weight: bold;
    font-size: 13px;
}

.qte-two-col .notes {
    font-size: 11px;
    color: var(--color-text-dark-secondary); /* 使用 FVTT 原生变量适配深色模式 */
    margin: 0;
    text-align: center;
}

/* 顶部说明框 */
.qte-header-note {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--color-border-light-primary);
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 底部按钮 */
.qte-footer {
    margin-top: 15px;
    display: flex;
    justify-content: center;
}
.qte-footer button {
    width: 100%;
}

/* =========================================
   新增：Dialog 并排布局样式
   ========================================= */
.qte-two-col {
    display: flex;
    gap: 15px; /* 增加列之间的间距 */
    justify-content: space-between;
    margin-bottom: 10px;
}

/* 强制重写 form-group 的默认行为，改为垂直堆叠 */
.qte-two-col .form-group {
    flex: 1;
    display: flex;
    flex-direction: column !important; /* 强制垂直排列 */
    align-items: center;
    height: auto !important; /* 关键：允许高度自动撑开，防止重叠 */
    margin: 0;
    gap: 4px;
}

.qte-two-col label {
    flex: initial !important;
    text-align: center;
    font-weight: bold;
    width: 100%;
}

.qte-two-col .form-fields {
    flex: initial !important;
    width: 100%;
}

.qte-two-col input {
    width: 100%;
    text-align: center;
}

/* 说明文字样式 */
.qte-two-col .notes {
    flex: initial !important;
    margin: 0 !important;
    font-size: 11px;
    color: #666;
    text-align: center;
    white-space: nowrap; /* 防止文字换行导致更难看 */
}

/* =========================================
   连打模式 (Mash Mode) 专用样式
   ========================================= */

/* 连打主容器 */
.qte-mash-wrapper {
    position: absolute;
    top: 70%; left: 50%;
    transform: translate(-50%, -50%);
    width: 650px; /* 稍微加宽以容纳图标 */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

/* 连打提示文字 */
.qte-mash-prompt {
    font-size: 36px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 10px #00d2ff;
    animation: pulseText 0.5s infinite alternate;
    margin-bottom: 5px;
}

/* 新增：图标行容器 (骷髅 - 进度条 - 拳头) */
.qte-mash-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    width: 100%;
}

/* 侧边图标样式 */
.mash-icon {
    font-size: 42px;
    filter: drop-shadow(0 0 8px rgba(0,0,0,0.8));
    width: 50px;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* 敌人图标动画 */
.mash-icon.enemy { 
    color: #ff0055; 
    animation: pulseEnemy 0.8s infinite alternate; 
}
/* 玩家图标 */
.mash-icon.player { 
    color: #ffcc00; 
}

/* 进度条外框 (金属质感) */
.qte-progress-track {
    flex: 1; /* 占满中间剩余空间 */
    height: 50px;
    background: #0d0d0d;
    border: 3px solid #555;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: inset 0 0 15px #000, 0 0 20px rgba(0,0,0,0.6);
    position: relative;
}

/* 中间的分界线 (50%处) */
.qte-progress-track::before {
    content: '';
    position: absolute;
    left: 50%; top: 0; bottom: 0;
    width: 2px;
    background: rgba(255,255,255,0.2);
    z-index: 5;
    pointer-events: none;
}

/* 进度条填充层 */
.qte-progress-fill {
    height: 100%;
    width: 50%;
    /* 激烈的渐变色：深红 -> 亮红 -> 金黄 */
    background: linear-gradient(90deg, #880000 0%, #ff0044 60%, #ffcc00 100%);
    box-shadow: 0 0 15px #ff0044;
    position: relative;
    transition: width 0.05s linear; /* 保证跟手 */
}

/* 高光闪烁效果 (JS控制添加 .flash 类) */
.qte-progress-fill.flash {
    filter: brightness(1.6);
}

/* 进度条纹理 */
.qte-progress-fill::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(
        45deg, 
        rgba(255,255,255,0.15) 25%, 
        transparent 25%, 
        transparent 50%, 
        rgba(255,255,255,0.15) 50%, 
        rgba(255,255,255,0.15) 75%, 
        transparent 75%, 
        transparent
    );
    background-size: 20px 20px;
}

/* 动画定义 */
@keyframes pulseText {
    from { transform: scale(1); opacity: 0.8; }
    to { transform: scale(1.05); opacity: 1; }
}

@keyframes pulseEnemy {
    from { transform: scale(1); filter: drop-shadow(0 0 5px #ff0055); }
    to { transform: scale(1.15); filter: drop-shadow(0 0 15px #ff0055); }
}

/* 抖动动画 (仅作用于轨道) */
.shake-pulse {
    animation: shake 0.1s cubic-bezier(.36,.07,.19,.97) both;
}

@keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-2px, 0, 0); }
    40%, 60% { transform: translate3d(2px, 0, 0); }
}

/* 新增：连打倒计时样式 */
.qte-timer {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    background: rgba(0, 0, 0, 0.5);
    padding: 2px 12px;
    border-radius: 12px;
    border: 1px solid #555;
    margin-top: 5px; /* 与上方提示文字拉开距离 */
    font-family: monospace; /* 等宽字体防止数字跳动 */
}

/* 当时间少于3秒时变红警告 */
.qte-timer.urgent {
    color: #ff3333;
    border-color: #ff3333;
    animation: pulseText 0.2s infinite alternate;
}